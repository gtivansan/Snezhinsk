<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <script src="static/fly.js"></script>
    <script src="static/snowflake_editor.js"></script>

    <link rel="stylesheet" href="static/snowflake_editor.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa&display=swap" rel="stylesheet">

    <title>Снежинск</title>
</head>
<body>
    <svg width="0" height="0">
        <defs>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" enable-background="new 0 0 50 50" id="trashIcon"><path d="M20 18h2v16h-2z"/><path d="M24 18h2v16h-2z"/><path d="M28 18h2v16h-2z"/><path d="M12 12h26v2H12z"/><path d="M30 12h-2v-1c0-.6-.4-1-1-1h-4c-.6 0-1 .4-1 1v1h-2v-1c0-1.7 1.3-3 3-3h4c1.7 0 3 1.3 3 3v1z"/><path d="M31 40H19c-1.6 0-3-1.3-3.2-2.9l-1.8-24 2-.2 1.8 24c0 .6.6 1.1 1.2 1.1h12c.6 0 1.1-.5 1.2-1.1l1.8-24 2 .2-1.8 24C34 38.7 32.6 40 31 40z"/>
            </svg>
        </defs>
    </svg>
    <div id="header">
        <button id="ready">Готово!</button>
        <button id="help">?</button>
    </div>
    <div id="readyPopup" style="display: none">
        <div class="popup-back" id="readyPopupBack"></div>
        <div class="popup-window" id="readyPopupWindow">
            <h2>Подпишите вашу снежинку</h2>
            <hr noshade color="#ceced8" size="1">
            <svg width="300" height="300" viewbox="0 0 500 500">
                <g filter="url(#blur)">
                    <rect x="0" y="0" width="500" height="500" fill="grey" 
                        mask="url(#flakeMask)" transform="translate(5, 5)"/>
                </g>
                <rect x="0" y="0" width="500" height="500" fill="#7373ff" mask="url(#flakeMask)"/>
            </svg><br>
            <input id="inputFlakeName">
            <button id="inputSubmit">Отправить</button>
            <button id="readyPopupClose" class="popup-close">x</button>
        </div>
    </div>
    <div id="canvasContainer">
        <svg id="flake">
            <clipPath id="masksContainer"></clipPath>
            <symbol id="flakeraw">
                <path d="M 134 450 L 250 249 L 366 450 Z"/>
            </symbol>   
            <symbol id="flakeangle">
                <use href="#flakeraw" fill="white" stroke-width="0" stroke="white"/>
                <use clip-path="url(#masksContainer)" href="#flakeraw" fill="black" stroke-width="2" stroke="black"/>
            </symbol>
            <symbol id="flakeshape">
                <rect x="0" y="0" width="500" height="500" fill="black"/>
                <use href="#flakeangle" transform="rotate(0, 250 250)"/>
                <use href="#flakeangle" transform="rotate(60, 250 250)"/>
                <use href="#flakeangle" transform="rotate(120, 250 250)"/>
                <use href="#flakeangle" transform="rotate(180, 250 250)"/>
                <use href="#flakeangle" transform="rotate(240, 250 250)"/>
                <use href="#flakeangle" transform="rotate(300, 250 250)"/>
            </symbol>
            <mask id="flakeMask">
                <use href="#flakeshape"/>
            </mask>
            <mask id="flakeangleMask">
                <rect x="0" y="0" width="500" height="500" fill="black"/>
                <use href="#flakeangle"/>
            </mask>
            <filter id="blur">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" />
            </filter>
            <g filter="url(#blur)">
                <rect x="0" y="0" width="500" height="500" fill="grey" 
                    mask="url(#flakeMask)" transform="translate(5, 5)"/>
            </g>
            <rect x="0" y="0" width="500" height="500" fill="#7373ff" mask="url(#flakeMask)"/>
        </svg>
        <svg id="tools">
            <g filter="url(#blur)">
                <rect x="0" y="0" width="500" height="500" fill="grey" 
                    mask="url(#flakeangleMask)" transform="translate(5, 5)"/>
            </g>
            <rect x="0" y="0" width="500" height="500" fill="#7373ff" mask="url(#flakeangleMask)"/>
        </svg>
    </div>
    <div id="toolsBox">
        <div id="layersBar">
            <div class="layers-head">
                <!-- <span>Layers</span> -->
            </div>
            <div class="layers-footer layer lonely" id="layersFooter">
                <span>+</span>
            </div>
        </div>
        <div id="toolsBar">
            <h1>Инструменты</h1>
            <div class="tools-group">
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>     
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
            </div>
            <h1>Трафареты</h1>
            <div class="tools-group">
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>     
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
                <div class="tool">
                    <p class="in-work">В работе</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        let toolsCanvas = document.getElementById("tools");
        let flakerawCanvas = document.getElementById("flakeraw");
        let masksContainer = document.getElementById("masksContainer");
        let layersBar = document.getElementById("layersBar");
        let layersFooter = document.getElementById("layersFooter");
        let readyButton = document.getElementById("ready");
        let readyPopup = document.getElementById("readyPopup");
        let readyCloseButton = document.getElementById("readyPopupClose");
        let readyPopupWindow = document.getElementById("readyPopupWindow");
        let readyPopupBack = document.getElementById("readyPopupBack");

        let tools = {};
        let activeLayerId = 0;
        let toolsCounter = 0;

        layersFooter.addEventListener("click", addLayer);
        addLayer();
        readyButton.addEventListener("click", showReadyPopup);
        readyCloseButton.addEventListener("click", hideReadyPopup);
        readyPopupBack.addEventListener("click", hideReadyPopup);

        function layerOnclick(id, event) {
            let layer = document.getElementById("layer_" + id);
            if (["use", "svg"].includes(event.target.tagName)) {
                deleteLayer(id);
            } else {
                activateLayer(id);
            }
        }

        function addLayer() {  
            let layer = document.createElement("div");
            layer.setAttribute("class", "layer");
            layer.setAttribute("id", "layer_" + toolsCounter);
            let layerId = document.createElement("span");
            layerId.setAttribute("class", "layer-id");
            layerId.innerText = toolsCounter + 1;
            let layerDel = document.createElementNS(svgNS, "svg");
            layerDel.setAttribute("width", "35");
            layerDel.setAttribute("height", "35");
            layerDel.setAttribute("class", "layer-del");
            let use = document.createElementNS(svgNS, "use");
            use.setAttribute("href", "#trashIcon");
            use.setAttribute("overflow", "visible");
            layer.appendChild(layerId);
            layer.appendChild(layerDel);
            layerDel.appendChild(use);
            let id = toolsCounter;
            layer.addEventListener("click", (event) => layerOnclick(id, event));
            layersFooter.before(layer);
            tools[toolsCounter] = new ToolChain(toolsCounter, toolsCanvas, masksContainer);
            activateLayer(toolsCounter);
            toolsCounter += 1;
        }

        function activateLayer(id) {
            let activeLayer = document.getElementById("layer_" + activeLayerId);
            if (activeLayer) {activeLayer.classList.remove("layer-active");}
            let newActiveLayer = document.getElementById("layer_" + id)
            newActiveLayer.classList.add("layer-active");
            if (tools[activeLayerId]) {tools[activeLayerId].deactivate();}
            activeLayerId = id;
            tools[activeLayerId].activate();
        }

        function deleteLayer(id) {
            tools[id].delete();
            delete tools[id];
            if (activeLayerId == id) {
                let newId = Object.keys(tools)[0];
                if (newId) {activateLayer(newId);}
                console.log(newId);
            }
            let layer = document.getElementById("layer_" + id);
            layersBar.removeChild(layer);     
        }

        function showReadyPopup() {
            readyPopup.style.display = "";
            readyPopupWindow.classList.add("popup-window-animated");
            readyPopupBack.classList.add("popup-back-animated");
        }

        function hideReadyPopup() {
            readyPopupWindow.classList.remove("popup-window-animated");
            readyPopupBack.classList.remove("popup-back-animated");
            setTimeout(function() {
                readyPopupWindow.classList.add("popup-window-reverse-animated");
                readyPopupBack.classList.add("popup-back-reverse-animated");
            }, 1);
            setTimeout(function() {
                readyPopup.style.display = "none";
                readyPopupWindow.classList.remove("popup-window-reverse-animated");
                readyPopupBack.classList.remove("popup-back-reverse-animated");
            }, 700)
        }
    </script>
</body>
</html>