<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <script src="static/fly.js"></script>
    <script src="static/snowflake_editor.js"></script>

    <link rel="stylesheet" href="static/snowflake_editor.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa&display=swap" rel="stylesheet">

    <title>Снежинск</title>
</head>
<body>
    <svg>
        <defs>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" enable-background="new 0 0 50 50" id="trashIcon"><path d="M20 18h2v16h-2z"/><path d="M24 18h2v16h-2z"/><path d="M28 18h2v16h-2z"/><path d="M12 12h26v2H12z"/><path d="M30 12h-2v-1c0-.6-.4-1-1-1h-4c-.6 0-1 .4-1 1v1h-2v-1c0-1.7 1.3-3 3-3h4c1.7 0 3 1.3 3 3v1z"/><path d="M31 40H19c-1.6 0-3-1.3-3.2-2.9l-1.8-24 2-.2 1.8 24c0 .6.6 1.1 1.2 1.1h12c.6 0 1.1-.5 1.2-1.1l1.8-24 2 .2-1.8 24C34 38.7 32.6 40 31 40z"/>
            </svg>
        </defs>
    </svg>
    <div id="canvasContainer">
        <svg id="flake">
            <clipPath id="masksContainer"></clipPath>
            <symbol id="flakeraw">
                <path d="M 134 450 L 250 249 L 366 450 Z"/>
            </symbol>   
            <symbol id="flakeangle">
                <use href="#flakeraw" fill="white" stroke-width="0" stroke="white"/>
                <use clip-path="url(#masksContainer)" href="#flakeraw" fill="black" stroke-width="2" stroke="black"/>
            </symbol>
            <symbol id="flakeshape">
                <rect x="0" y="0" width="500" height="500" fill="black"/>
                <use href="#flakeangle" transform="rotate(0, 250 250)"/>
                <use href="#flakeangle" transform="rotate(60, 250 250)"/>
                <use href="#flakeangle" transform="rotate(120, 250 250)"/>
                <use href="#flakeangle" transform="rotate(180, 250 250)"/>
                <use href="#flakeangle" transform="rotate(240, 250 250)"/>
                <use href="#flakeangle" transform="rotate(300, 250 250)"/>
            </symbol>
            <mask id="flakeMask">
                <use href="#flakeshape"/>
            </mask>
            <mask id="flakeangleMask">
                <rect x="0" y="0" width="500" height="500" fill="black"/>
                <use href="#flakeangle"/>
            </mask>
            <filter id="blur">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" />
            </filter>
            <g filter="url(#blur)">
                <rect x="0" y="0" width="500" height="500" fill="grey" 
                    mask="url(#flakeMask)" transform="translate(5, 5)"/>
            </g>
            <rect x="0" y="0" width="500" height="500" fill="#7373ff" mask="url(#flakeMask)"/>
        </svg>
        <svg id="tools">
            <g filter="url(#blur)">
                <rect x="0" y="0" width="500" height="500" fill="grey" 
                    mask="url(#flakeangleMask)" transform="translate(5, 5)"/>
            </g>
            <rect x="0" y="0" width="500" height="500" fill="#7373ff" mask="url(#flakeangleMask)"/>
        </svg>
    </div>
    <div id="toolsBox">
        <div id="layersBar">
            <div class="layers-head">
                <span>Layers</span>
            </div>
            <div class="layers-footer layer lonely" id="layersFooter">
                <span>+</span>
            </div>
        </div>
        <div id="toolsBar">
            <h1>Tools</h1>
        </div>
    </div>
    <script>
        let toolsCanvas = document.getElementById("tools");
        let flakerawCanvas = document.getElementById("flakeraw");
        let masksContainer = document.getElementById("masksContainer");

        // let tool = new ToolChain(0, toolsCanvas, masksContainer);
        let tools = [];
        let activeLayerId = 0;
        let layersBar = document.getElementById("layersBar");
        let layersFooter = document.getElementById("layersFooter");

        layersFooter.addEventListener("click", addLayer);

        function addLayer() {  
            let layer = document.createElement("div");
            layer.setAttribute("class", "layer");
            layer.setAttribute("id", "layer_" + tools.length);
            let layerId = document.createElement("span");
            layerId.setAttribute("class", "layer-id");
            layerId.innerText = tools.length + 1;
            let layerDel = document.createElementNS(svgNS, "svg");
            layerDel.setAttribute("width", "35");
            layerDel.setAttribute("height", "35");
            layerDel.setAttribute("class", "layer-del");
            let use = document.createElementNS(svgNS, "use");
            use.setAttribute("href", "#trashIcon");
            use.setAttribute("overflow", "visible");
            layer.appendChild(layerId);
            layer.appendChild(layerDel);
            layerDel.appendChild(use);
            let id = tools.length
            layer.addEventListener("click", (event) => activateLayer(id));
            // layersBar.appendChild(layer);
            layersFooter.before(layer);

            tools.push(new ToolChain(tools.length, toolsCanvas, masksContainer));
            activateLayer(tools.length - 1);
        }

        function activateLayer(id) {
            let activeLayer = document.getElementById("layer_" + activeLayerId);
            activeLayer.classList.remove("layer-active");
            let newActiveLayer = document.getElementById("layer_" + id)
            // console.log(id, newActiveLayer);
            newActiveLayer.classList.add("layer-active");
            tools[activeLayerId].deactivate();
            activeLayerId = id;
            tools[activeLayerId].activate();
        }

        addLayer();
    </script>
</body>
</html>